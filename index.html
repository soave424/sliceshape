<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì‹¤ì‹œê°„ ì˜¨ë¼ì¸ ë¹™ê³  ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
      }
      /* Custom modal for alerts */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 0.75rem;
        text-align: center;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        max-width: 90%;
        width: 400px;
      }
      .modal-content p {
        margin-bottom: 1.5rem;
        font-size: 1.125rem;
      }
      .modal-content button {
        background-color: #f59e0b; /* amber-500 */
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        font-weight: bold;
      }
      .modal-content button:hover {
        background-color: #d97706; /* amber-600 */
      }
      .bingo-cell {
        aspect-ratio: 1 / 1;
        padding: 4px;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        word-break: break-word; /* ê¸´ ë‹¨ì–´ ì¤„ë°”ê¿ˆ */
        white-space: normal; /* ìë™ ì¤„ë°”ê¿ˆ í—ˆìš© */
        position: relative;
      }
      .bingo-cell.marked {
        background-color: #f59e0b; /* amber-500 */
        color: white;
      }
      .bingo-cell.marked::after {
        content: "âœ”";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        color: rgba(255, 255, 255, 0.7);
        z-index: 1;
      }
      .bingo-input-div {
        width: 100%;
        height: 100%;
        border: none;
        background-color: transparent;
        font-size: inherit;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
      }
      .bingo-input-div:focus {
        outline: none;
        background-color: #fef3c7; /* amber-100 */
      }
      .turn-highlight {
        box-shadow: 0 0 15px 5px #34d399; /* emerald-400 */
      }
      .host-clickable {
        cursor: pointer;
      }
      .host-clickable:hover {
        background-color: #d1fae5; /* emerald-100 */
      }
      .bingo-grid-container {
        position: relative;
      }
      .bingo-line-svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 2;
      }
      .bingo-line {
        stroke: #dc2626; /* red-600 */
        stroke-width: 5;
        stroke-linecap: round;
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <div id="app-container" class="max-w-7xl mx-auto p-4">
      <!-- ì´ˆê¸° í™”ë©´: ë°© ë§Œë“¤ê¸° / ì°¸ì—¬í•˜ê¸° -->
      <div
        id="home-screen"
        class="text-center max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg"
      >
        <h1 class="text-4xl font-bold mb-2 text-amber-500">
          ì‹¤ì‹œê°„ ë¹™ê³  ê²Œì„!
        </h1>
        <p class="text-gray-600 mb-8">ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ ì¦ê±°ìš´ ë¹™ê³  í•œ íŒ!</p>

        <div class="space-y-4">
          <button
            id="show-create-room-btn"
            class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-300"
          >
            ë°© ë§Œë“¤ê¸°
          </button>
          <button
            id="show-join-room-btn"
            class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-300"
          >
            ì°¸ì—¬í•˜ê¸°
          </button>
        </div>

        <div id="create-room-form" class="hidden mt-8 text-left space-y-4">
          <h2 class="text-2xl font-semibold text-center">ìƒˆë¡œìš´ ë°© ë§Œë“¤ê¸°</h2>
          <div>
            <label for="topic" class="block text-sm font-medium text-gray-700"
              >ë¹™ê³  ì£¼ì œ</label
            >
            <input
              type="text"
              id="topic"
              placeholder="ì˜ˆ: ìŒì‹, ë™ë¬¼, ì˜í™” ì œëª©"
              class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500"
            />
          </div>
          <div>
            <label for="size" class="block text-sm font-medium text-gray-700"
              >ë¹™ê³  í¬ê¸°</label
            >
            <select
              id="size"
              class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500"
            >
              <option value="3">3x3</option>
              <option value="4">4x4</option>
              <option value="5" selected>5x5</option>
            </select>
          </div>
          <div>
            <label
              for="win-condition"
              class="block text-sm font-medium text-gray-700"
              >ìš°ìŠ¹ ì¡°ê±´ (ë¹™ê³  ê°œìˆ˜)</label
            >
            <input
              type="number"
              id="win-condition"
              value="1"
              min="1"
              class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500"
            />
          </div>
          <div>
            <label
              for="end-condition"
              class="block text-sm font-medium text-gray-700"
              >ê²Œì„ ì¢…ë£Œ ì¸ì›</label
            >
            <input
              type="number"
              id="end-condition"
              value="1"
              min="1"
              class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500"
            />
          </div>

          <div class="mt-4 pt-4 border-t">
            <label class="flex items-center">
              <input
                type="checkbox"
                id="enable-random-fill"
                class="h-4 w-4 rounded border-gray-300 text-amber-600 focus:ring-amber-500"
              />
              <span class="ml-2 text-sm font-medium text-gray-700"
                >ê²ŒìŠ¤íŠ¸ 'ëœë¤ ì±„ìš°ê¸°' ê¸°ëŠ¥ ì‚¬ìš©</span
              >
            </label>
          </div>
          <div id="random-words-container" class="hidden">
            <label
              for="random-words-list"
              class="block text-sm font-medium text-gray-700"
              >ëœë¤ ë‹¨ì–´ ëª©ë¡</label
            >
            <textarea
              id="random-words-list"
              rows="4"
              class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500"
              placeholder="ë‹¨ì–´ ëª©ë¡ì„ ì‰¼í‘œ(,) ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”."
            ></textarea>
          </div>

          <button
            id="create-room-btn"
            class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
          >
            ìƒì„±í•˜ê¸°
          </button>
        </div>

        <div id="join-room-form" class="hidden mt-8 text-left space-y-4">
          <h2 class="text-2xl font-semibold text-center">ë°© ì°¸ì—¬í•˜ê¸°</h2>
          <div>
            <label
              for="room-code-input"
              class="block text-sm font-medium text-gray-700"
              >ë°© ì½”ë“œ</label
            >
            <input
              type="text"
              id="room-code-input"
              placeholder="ê³µìœ ë°›ì€ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
              class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          <div>
            <label
              for="nickname-input"
              class="block text-sm font-medium text-gray-700"
              >ë‹‰ë„¤ì„</label
            >
            <input
              type="text"
              id="nickname-input"
              placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
              class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
          <button
            id="join-room-btn"
            class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
          >
            ì…ì¥í•˜ê¸°
          </button>
        </div>
        <p id="home-error" class="text-red-500 mt-4"></p>
      </div>

      <!-- ê²Œì„ ëŒ€ê¸° í™”ë©´ -->
      <div id="waiting-room-screen" class="hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg mb-4">
          <h2 class="text-2xl font-bold">ëŒ€ê¸° ì¤‘...</h2>
          <p class="text-gray-600">
            ì£¼ì œ:
            <span id="wait-topic" class="font-semibold text-amber-600"></span>
          </p>
          <div class="mt-4">
            <p class="text-gray-600">ì¹œêµ¬ë“¤ì—ê²Œ ë°© ì½”ë“œë¥¼ ê³µìœ í•´ì£¼ì„¸ìš”!</p>
            <div
              class="flex items-center justify-center mt-2 bg-gray-100 p-3 rounded-lg"
            >
              <span
                id="room-code-display"
                class="text-3xl font-mono tracking-widest text-emerald-600"
              ></span>
              <button
                id="copy-code-btn"
                class="ml-4 bg-gray-200 hover:bg-gray-300 p-2 rounded-md"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-6 w-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <div class="grid md:grid-cols-3 gap-4">
          <!-- ì°¸ê°€ì ëª©ë¡ (í˜¸ìŠ¤íŠ¸/ê²ŒìŠ¤íŠ¸ ê³µí†µ) -->
          <div class="md:col-span-1 bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-semibold mb-4">
              ì°¸ê°€ì ëª©ë¡ (<span id="player-count"></span>ëª…)
            </h3>
            <ul id="player-list" class="space-y-2"></ul>
          </div>

          <!-- ë‚´ ë¹™ê³ íŒ (ê²ŒìŠ¤íŠ¸) / ì „ì²´ ë¹™ê³ íŒ ë¯¸ë¦¬ë³´ê¸° (í˜¸ìŠ¤íŠ¸) -->
          <div
            id="my-bingo-panel"
            class="md:col-span-2 bg-white p-6 rounded-xl shadow-lg"
          >
            <!-- ê²ŒìŠ¤íŠ¸ ë¹™ê³ íŒ ì…ë ¥ -->
            <div id="guest-bingo-setup">
              <h3 class="text-xl font-semibold mb-4">ë‚´ ë¹™ê³ íŒ ì±„ìš°ê¸°</h3>
              <div id="my-bingo-grid-container" class="mb-4"></div>
              <div class="flex space-x-2">
                <button
                  id="random-fill-btn"
                  class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition"
                >
                  ëœë¤ ì±„ìš°ê¸°
                </button>
                <button
                  id="submit-board-btn"
                  class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg transition"
                >
                  ì œì¶œí•˜ê¸°
                </button>
              </div>
              <p id="guest-wait-message" class="mt-4 text-center text-gray-500">
                ë¹™ê³ íŒì„ ì±„ìš°ê³  ì œì¶œí•´ì£¼ì„¸ìš”. í˜¸ìŠ¤íŠ¸ê°€ ê²Œì„ì„ ì‹œì‘í•  ë•Œê¹Œì§€
                ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
              </p>
            </div>
            <!-- í˜¸ìŠ¤íŠ¸ ì „ì²´ ë¹™ê³ íŒ ë¯¸ë¦¬ë³´ê¸° -->
            <div id="host-bingo-preview" class="hidden">
              <h3 class="text-xl font-semibold mb-4">ì „ì²´ ë¹™ê³ íŒ ë¯¸ë¦¬ë³´ê¸°</h3>
              <div
                id="all-bingo-boards-preview"
                class="grid grid-cols-2 lg:grid-cols-3 gap-4"
              ></div>
              <button
                id="start-game-btn"
                class="mt-6 w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition disabled:bg-gray-400 disabled:cursor-not-allowed"
              >
                ê²Œì„ ì‹œì‘
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ê²Œì„ ì§„í–‰ í™”ë©´ -->
      <div id="game-screen" class="hidden">
        <div
          class="flex justify-between items-center bg-white p-4 rounded-xl shadow-lg mb-4"
        >
          <div>
            <h2 class="text-2xl font-bold">ë¹™ê³  ê²Œì„ ì§„í–‰ ì¤‘!</h2>
            <p class="text-gray-600">
              ì£¼ì œ:
              <span id="game-topic" class="font-semibold text-amber-600"></span>
            </p>
          </div>
          <div id="turn-info" class="text-right">
            <p class="text-lg">
              í˜„ì¬ ì°¨ë¡€:
              <span
                id="current-turn-player"
                class="font-bold text-emerald-600"
              ></span>
            </p>
          </div>
        </div>

        <div class="grid lg:grid-cols-4 gap-6">
          <!-- ë‚´ ë¹™ê³ íŒ (ê²ŒìŠ¤íŠ¸) / ì „ì²´ ë¹™ê³ íŒ (í˜¸ìŠ¤íŠ¸) -->
          <div id="game-main-panel" class="lg:col-span-3">
            <div id="guest-game-view" class="bg-white p-6 rounded-xl shadow-lg">
              <h3 class="text-xl font-semibold mb-4">
                ë‚´ ë¹™ê³ íŒ (<span id="my-nickname-display"></span>)
              </h3>
              <div id="game-my-bingo-grid" class="mb-4"></div>
              <div id="my-turn-actions" class="hidden text-center">
                <p class="font-semibold text-lg text-emerald-600 mb-2">
                  ë‹¹ì‹  ì°¨ë¡€ì…ë‹ˆë‹¤! ë°œí‘œí•  ë‹¨ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”.
                </p>
              </div>
            </div>
            <div id="host-game-view" class="hidden">
              <h3
                class="text-xl font-semibold mb-4 p-4 bg-white rounded-xl shadow-lg"
              >
                ì „ì²´ ì°¸ê°€ì ë¹™ê³ íŒ
              </h3>
              <div
                id="host-all-boards-view"
                class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mt-4"
              ></div>
            </div>
          </div>

          <!-- ê²Œì„ ì •ë³´ ë° ì»¨íŠ¸ë¡¤ -->
          <div class="lg:col-span-1 space-y-6">
            <!-- ì°¸ê°€ì í˜„í™© -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
              <h3 class="text-xl font-semibold mb-4">ì°¸ê°€ì í˜„í™©</h3>
              <ul id="game-player-list" class="space-y-3"></ul>
            </div>
            <!-- ë°œí‘œëœ ë‹¨ì–´ -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
              <h3 class="text-xl font-semibold mb-4">ë°œí‘œëœ ë‹¨ì–´</h3>
              <div
                id="called-words-list"
                class="h-40 overflow-y-auto bg-gray-50 p-3 rounded-md space-y-1"
              ></div>
            </div>
            <!-- í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
            <div
              id="host-controls"
              class="hidden bg-white p-6 rounded-xl shadow-lg"
            >
              <h3 class="text-xl font-semibold mb-4">í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤</h3>
              <div id="word-requests-list" class="space-y-2 mb-4">
                <p class="text-gray-500">ì•„ì§ ë‹¨ì–´ ì¸ì • ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
              <button
                id="skip-turn-btn"
                class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg mb-2"
              >
                í„´ ë„˜ê¸°ê¸°
              </button>
              <button
                id="manual-end-game-btn"
                class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg"
              >
                ê²Œì„ ê°•ì œ ì¢…ë£Œ
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ê²Œì„ ê²°ê³¼ í™”ë©´ -->
      <div
        id="result-screen"
        class="hidden text-center max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg"
      >
        <h1 class="text-4xl font-bold mb-4 text-amber-500">ê²Œì„ ì¢…ë£Œ!</h1>
        <h2 class="text-2xl font-semibold mb-6">ìµœì¢… ìˆœìœ„</h2>
        <div id="final-rankings" class="space-y-3 mb-8"></div>

        <h2 class="text-2xl font-semibold mb-4">ì¸ê¸° ë‹¨ì–´ Top 5</h2>
        <div id="top-words" class="space-y-2 text-lg"></div>

        <button
          id="back-to-home-btn"
          class="mt-8 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-300"
        >
          ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </button>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // Firebase SDKë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        onSnapshot,
        collection,
        query,
        where,
        getDocs,
        writeBatch,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ê´€ë¦¬ ---
      const firebaseConfig = {
        apiKey: "AIzaSyCJJ5u8sBeqTPjvVfnSulRRmRXKaE091us",
        authDomain: "bingo-98fd5.firebaseapp.com",
        projectId: "bingo-98fd5",
        storageBucket: "bingo-98fd5.appspot.com",
        messagingSenderId: "790406549720",
        appId: "1:790406549720:web:7d67328446c693415847ad",
        measurementId: "G-L3DDKT71T3",
      };
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-bingo-app";

      let app, auth, db;
      let userId, userNickname;
      let currentGameId = null;
      let currentRoomCode = null;
      let isHost = false;
      let unsubscribeGame = null; // onSnapshot ë¦¬ìŠ¤ë„ˆ í•´ì œë¥¼ ìœ„í•œ ë³€ìˆ˜

      // --- UI ìš”ì†Œ ---
      const screens = {
        home: document.getElementById("home-screen"),
        waiting: document.getElementById("waiting-room-screen"),
        game: document.getElementById("game-screen"),
        result: document.getElementById("result-screen"),
      };

      // --- ì´ˆê¸°í™” ---
      document.addEventListener("DOMContentLoaded", () => {
        try {
          if (!firebaseConfig.apiKey) {
            throw new Error("Firebase config is missing.");
          }
          app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getFirestore(app);
          setupEventListeners();
          setupAuthListener();
        } catch (error) {
          console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
          showCustomAlert(
            "ì´ˆê¸°í™” ì‹¤íŒ¨: Firebase ì„¤ì •ì´ ëˆ„ë½ë˜ì—ˆê±°ë‚˜ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”."
          );
        }
      });

      // --- ì¸ì¦ ì„¤ì • ---
      function setupAuthListener() {
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            userId = user.uid;
            if (!currentGameId) {
              await checkForExistingSession();
            }
          } else {
            try {
              await signInAnonymously(auth);
            } catch (error) {
              console.error("Authentication Error:", error);
              if (error.code === "auth/configuration-not-found") {
                showCustomAlert(
                  "ì¸ì¦ ì„¤ì • ì˜¤ë¥˜: Firebase ì½˜ì†”ì—ì„œ 'ìµëª…' ë¡œê·¸ì¸ ë°©ì‹ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."
                );
              } else {
                showCustomAlert("ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
              }
              document.getElementById("home-error").textContent =
                "ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firebase ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
            }
          }
        });
      }

      // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
      function setupEventListeners() {
        // í™ˆ í™”ë©´
        document
          .getElementById("show-create-room-btn")
          .addEventListener("click", () => {
            document
              .getElementById("create-room-form")
              .classList.remove("hidden");
            document.getElementById("join-room-form").classList.add("hidden");
          });
        document
          .getElementById("show-join-room-btn")
          .addEventListener("click", () => {
            document
              .getElementById("join-room-form")
              .classList.remove("hidden");
            document.getElementById("create-room-form").classList.add("hidden");
          });
        document
          .getElementById("create-room-btn")
          .addEventListener("click", createRoom);
        document
          .getElementById("join-room-btn")
          .addEventListener("click", joinRoom);
        document
          .getElementById("copy-code-btn")
          .addEventListener("click", copyRoomCode);
        document
          .getElementById("enable-random-fill")
          .addEventListener("change", (e) => {
            document
              .getElementById("random-words-container")
              .classList.toggle("hidden", !e.target.checked);
          });

        // ëŒ€ê¸°ì‹¤
        document
          .getElementById("random-fill-btn")
          .addEventListener("click", randomFillBoard);
        document
          .getElementById("submit-board-btn")
          .addEventListener("click", submitBoard);
        document
          .getElementById("start-game-btn")
          .addEventListener("click", startGame);

        // ê²Œì„ í™”ë©´
        document
          .getElementById("skip-turn-btn")
          .addEventListener("click", skipTurn);
        document
          .getElementById("manual-end-game-btn")
          .addEventListener("click", manualEndGame);

        // ê²°ê³¼ í™”ë©´
        document
          .getElementById("back-to-home-btn")
          .addEventListener("click", () => {
            clearSession();
            location.reload();
          });
      }

      // --- í™”ë©´ ì „í™˜ ---
      function showScreen(screenName) {
        Object.values(screens).forEach((screen) =>
          screen.classList.add("hidden")
        );
        if (screens[screenName]) {
          screens[screenName].classList.remove("hidden");
        }
      }

      // --- ë°© ìƒì„± ë° ì°¸ì—¬ ---
      async function createRoom() {
        if (!userId) {
          document.getElementById("home-error").textContent =
            "ì‚¬ìš©ì ì¸ì¦ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }
        isHost = true;
        userNickname = "í˜¸ìŠ¤íŠ¸";

        const topic = document.getElementById("topic").value.trim();
        if (!topic) {
          document.getElementById("home-error").textContent =
            "ë¹™ê³  ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
          return;
        }

        const size = parseInt(document.getElementById("size").value);
        const winCondition = parseInt(
          document.getElementById("win-condition").value
        );
        const endCondition = parseInt(
          document.getElementById("end-condition").value
        );
        const enableRandomFill =
          document.getElementById("enable-random-fill").checked;
        let randomWords = [];
        if (enableRandomFill) {
          const rawWords = document.getElementById("random-words-list").value;
          randomWords = rawWords
            .split(/[\n,]/)
            .map((word) => word.trim())
            .filter((word) => word.length > 0);
        }
        currentRoomCode = generateRoomCode();

        const gameData = {
          hostId: userId,
          roomCode: currentRoomCode,
          topic: topic,
          size: size,
          winCondition: winCondition,
          endCondition: endCondition,
          isRandomFillEnabled: enableRandomFill,
          randomWords: randomWords,
          status: "waiting",
          players: {
            [userId]: {
              nickname: userNickname,
              isReady: true,
              board: [],
              marked: [],
              bingoCount: 0,
              isWinner: false,
            },
          },
          calledWords: [],
          turn: null,
          wordRequests: [],
          winners: [],
          createdAt: new Date(),
        };

        try {
          const gameCollectionPath = `/artifacts/${appId}/public/data/bingoGames`;
          const gameRef = doc(collection(db, gameCollectionPath));
          currentGameId = gameRef.id;
          await setDoc(gameRef, gameData);

          saveSession();
          listenToGameChanges(currentGameId);
          showScreen("waiting");
        } catch (error) {
          console.error("ë°© ìƒì„± ì˜¤ë¥˜:", error);
          document.getElementById("home-error").textContent =
            "ë°©ì„ ë§Œë“œëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        }
      }

      async function joinRoom() {
        const roomCode = document
          .getElementById("room-code-input")
          .value.trim()
          .toUpperCase();
        const nickname = document.getElementById("nickname-input").value.trim();

        if (!roomCode || !nickname) {
          document.getElementById("home-error").textContent =
            "ë°© ì½”ë“œì™€ ë‹‰ë„¤ì„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.";
          return;
        }
        if (!userId) {
          document.getElementById("home-error").textContent =
            "ì‚¬ìš©ì ì¸ì¦ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        userNickname = nickname;
        isHost = false;

        try {
          const gameCollectionPath = `/artifacts/${appId}/public/data/bingoGames`;
          const q = query(
            collection(db, gameCollectionPath),
            where("roomCode", "==", roomCode)
          );
          const querySnapshot = await getDocs(q);

          if (querySnapshot.empty) {
            document.getElementById("home-error").textContent =
              "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°© ì½”ë“œì…ë‹ˆë‹¤.";
            return;
          }

          const gameDoc = querySnapshot.docs[0];
          currentGameId = gameDoc.id;
          const gameData = gameDoc.data();

          if (gameData.status !== "waiting") {
            document.getElementById("home-error").textContent =
              "ì´ë¯¸ ì‹œì‘ë˜ì—ˆê±°ë‚˜ ì¢…ë£Œëœ ê²Œì„ì…ë‹ˆë‹¤.";
            return;
          }

          if (
            Object.values(gameData.players).some(
              (p) => p.nickname.toLowerCase() === nickname.toLowerCase()
            )
          ) {
            document.getElementById("home-error").textContent =
              "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.";
            return;
          }

          const newPlayerData = {
            nickname: userNickname,
            isReady: false,
            board: [],
            marked: [],
            bingoCount: 0,
            isWinner: false,
          };

          const gameRef = doc(db, gameCollectionPath, currentGameId);
          await updateDoc(gameRef, {
            [`players.${userId}`]: newPlayerData,
          });

          saveSession();
          listenToGameChanges(currentGameId);
          showScreen("waiting");
        } catch (error) {
          console.error("ë°© ì°¸ì—¬ ì˜¤ë¥˜:", error);
          document.getElementById("home-error").textContent =
            "ë°©ì— ì°¸ì—¬í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        }
      }

      function listenToGameChanges(gameId) {
        if (unsubscribeGame) unsubscribeGame();

        const gameCollectionPath = `/artifacts/${appId}/public/data/bingoGames`;
        const gameRef = doc(db, gameCollectionPath, gameId);

        unsubscribeGame = onSnapshot(
          gameRef,
          (doc) => {
            if (!doc.exists()) {
              showCustomAlert(
                "í˜¸ìŠ¤íŠ¸ê°€ ê²Œì„ì„ ì¢…ë£Œí–ˆê±°ë‚˜ ë°©ì´ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤. ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤."
              );
              clearSession();
              setTimeout(() => location.reload(), 2000);
              return;
            }
            const gameData = doc.data();
            updateUI(gameData);
          },
          (error) => {
            console.error("ê²Œì„ ë°ì´í„° ìˆ˜ì‹  ì˜¤ë¥˜:", error);
            showCustomAlert("ê²Œì„ ì„œë²„ì™€ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤.");
            clearSession();
            setTimeout(() => location.reload(), 2000);
          }
        );
      }

      function updateUI(gameData) {
        if (!gameData) return;

        if (gameData.status === "waiting") {
          showScreen("waiting");
          updateWaitingRoomUI(gameData);
        } else if (gameData.status === "playing") {
          showScreen("game");
          updateGameScreenUI(gameData);
        } else if (gameData.status === "finished") {
          showScreen("result");
          updateResultScreenUI(gameData);
        }
      }

      function updateWaitingRoomUI(gameData) {
        document.getElementById("wait-topic").textContent = gameData.topic;
        document.getElementById("room-code-display").textContent =
          gameData.roomCode;

        const players = Object.values(gameData.players);
        const playerListEl = document.getElementById("player-list");
        playerListEl.innerHTML = "";
        players.forEach((player) => {
          const li = document.createElement("li");
          li.className =
            "flex items-center justify-between p-2 rounded-md bg-gray-50";
          li.innerHTML = `
                    <span class="font-medium">${player.nickname}</span>
                    <span class="${
                      player.isReady ? "text-emerald-500" : "text-gray-400"
                    }">${player.isReady ? "ì¤€ë¹„ ì™„ë£Œ" : "ì¤€ë¹„ ì¤‘..."}</span>
                `;
          playerListEl.appendChild(li);
        });
        document.getElementById("player-count").textContent = players.length;

        if (isHost) {
          document.getElementById("guest-bingo-setup").classList.add("hidden");
          document
            .getElementById("host-bingo-preview")
            .classList.remove("hidden");

          const allBoardsPreviewEl = document.getElementById(
            "all-bingo-boards-preview"
          );
          allBoardsPreviewEl.innerHTML = "";
          Object.values(gameData.players).forEach((player) => {
            if (player.nickname === "í˜¸ìŠ¤íŠ¸") return;
            const playerBoardDiv = document.createElement("div");
            playerBoardDiv.className = "p-2 border rounded-lg";
            playerBoardDiv.innerHTML = `<p class="font-semibold text-center mb-2">${player.nickname}</p>`;
            const boardGrid = createBoardElement(
              gameData.size,
              player.board,
              [],
              false,
              null
            );
            playerBoardDiv.appendChild(boardGrid);
            allBoardsPreviewEl.appendChild(playerBoardDiv);
          });

          const allReady = players.every((p) => p.isReady);
          const startGameBtn = document.getElementById("start-game-btn");
          startGameBtn.disabled = !allReady || players.length < 2;
          startGameBtn.title = startGameBtn.disabled
            ? players.length < 2
              ? "ìµœì†Œ 2ëª… ì´ìƒ ì°¸ì—¬í•´ì•¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
              : "ëª¨ë“  ì°¸ê°€ìê°€ ì¤€ë¹„ë¥¼ ì™„ë£Œí•´ì•¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            : "";
        } else {
          document
            .getElementById("guest-bingo-setup")
            .classList.remove("hidden");
          document.getElementById("host-bingo-preview").classList.add("hidden");

          document
            .getElementById("random-fill-btn")
            .classList.toggle("hidden", !gameData.isRandomFillEnabled);

          const myPlayerData = gameData.players[userId];
          if (myPlayerData && myPlayerData.isReady) {
            document.getElementById("my-bingo-grid-container").innerHTML = "";
            const board = createBoardElement(
              gameData.size,
              myPlayerData.board,
              [],
              false,
              null
            );
            document
              .getElementById("my-bingo-grid-container")
              .appendChild(board);
            document.getElementById("random-fill-btn").classList.add("hidden");
            document.getElementById("submit-board-btn").classList.add("hidden");
            document.getElementById("guest-wait-message").textContent =
              "ë¹™ê³ íŒ ì œì¶œ ì™„ë£Œ! ê²Œì„ì´ ì‹œì‘ë˜ê¸°ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.";
          } else {
            createBingoInputGrid(gameData.size);
          }
        }
      }

      function updateGameScreenUI(gameData) {
        document.getElementById("game-topic").textContent = gameData.topic;

        const turnPlayerNickname =
          gameData.players[gameData.turn]?.nickname || "í˜¸ìŠ¤íŠ¸ê°€ ì§€ì •í•´ì£¼ì„¸ìš”";
        document.getElementById("current-turn-player").textContent =
          turnPlayerNickname;

        if (isHost) {
          document.getElementById("guest-game-view").classList.add("hidden");
          document.getElementById("host-game-view").classList.remove("hidden");
          document.getElementById("host-controls").classList.remove("hidden");

          const hostAllBoardsView = document.getElementById(
            "host-all-boards-view"
          );
          hostAllBoardsView.innerHTML = "";
          Object.entries(gameData.players).forEach(([pid, player]) => {
            if (pid === gameData.hostId) return;

            const playerContainer = document.createElement("div");
            playerContainer.className = "bg-white p-4 rounded-xl shadow-lg";

            const nicknameEl = document.createElement("h4");
            nicknameEl.className = "text-lg font-bold mb-2 text-center";
            nicknameEl.textContent = player.nickname;
            playerContainer.appendChild(nicknameEl);

            const boardGrid = createBoardElement(
              gameData.size,
              player.board,
              player.marked,
              false,
              pid
            );
            playerContainer.appendChild(boardGrid);
            hostAllBoardsView.appendChild(playerContainer);
          });
        } else {
          // Guest view
          document.getElementById("guest-game-view").classList.remove("hidden");
          document.getElementById("host-game-view").classList.add("hidden");
          document.getElementById("host-controls").classList.add("hidden");

          const myPlayerData = gameData.players[userId];
          if (!myPlayerData) return;

          document.getElementById("my-nickname-display").textContent =
            userNickname;
          const myBoardEl = document.getElementById("game-my-bingo-grid");
          myBoardEl.innerHTML = "";
          const myBoardGrid = createBoardElement(
            gameData.size,
            myPlayerData.board,
            myPlayerData.marked,
            gameData.turn === userId,
            userId
          );
          myBoardEl.appendChild(myBoardGrid);
          document
            .getElementById("my-turn-actions")
            .classList.toggle("hidden", gameData.turn !== userId);
        }

        const playerListEl = document.getElementById("game-player-list");
        playerListEl.innerHTML = "";
        const sortedPlayers = Object.entries(gameData.players).sort(
          ([, a], [, b]) => b.bingoCount - a.bingoCount
        );

        sortedPlayers.forEach(([pid, player]) => {
          if (pid === gameData.hostId) return;

          const li = document.createElement("li");
          li.className = `p-3 rounded-lg transition-all duration-300 ${
            gameData.turn === pid
              ? "turn-highlight bg-emerald-50"
              : "bg-gray-50"
          }`;
          if (isHost) {
            li.classList.add("host-clickable");
            li.onclick = () => setPlayerTurn(pid);
          }
          li.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold ${
                          player.isWinner ? "text-amber-500" : ""
                        }">${player.nickname} ${
            player.isWinner ? "ğŸ†" : ""
          }</span>
                        <span class="text-lg font-semibold">${
                          player.bingoCount
                        } ë¹™ê³ </span>
                    </div>
                `;
          playerListEl.appendChild(li);
        });

        const calledWordsEl = document.getElementById("called-words-list");
        calledWordsEl.innerHTML = "";
        gameData.calledWords
          .slice()
          .reverse()
          .forEach((word) => {
            const div = document.createElement("div");
            div.className = "px-2 py-1 bg-white rounded shadow-sm";
            div.textContent = word;
            calledWordsEl.appendChild(div);
          });

        const requestsListEl = document.getElementById("word-requests-list");
        requestsListEl.innerHTML = "";
        if (gameData.wordRequests && gameData.wordRequests.length > 0) {
          gameData.wordRequests.forEach((req) => {
            const div = document.createElement("div");
            div.className = "p-2 border rounded-md";
            div.innerHTML = `<p class="text-sm">'<span class="font-bold">${req.nickname}</span>'ë‹˜ì´ '<span class="text-blue-600">${req.word}</span>' ì¸ì • ìš”ì²­</p>`;

            const btnContainer = document.createElement("div");
            btnContainer.className = "flex space-x-2 mt-1";

            const approveBtn = document.createElement("button");
            approveBtn.textContent = "ì¸ì •";
            approveBtn.className =
              "flex-1 bg-emerald-500 text-white px-2 py-1 rounded-md text-sm hover:bg-emerald-600";
            approveBtn.onclick = () => approveWordRequest(req);

            const rejectBtn = document.createElement("button");
            rejectBtn.textContent = "ë¬´ì‹œ";
            rejectBtn.className =
              "flex-1 bg-gray-500 text-white px-2 py-1 rounded-md text-sm hover:bg-gray-600";
            rejectBtn.onclick = () => rejectWordRequest(req);

            btnContainer.appendChild(approveBtn);
            btnContainer.appendChild(rejectBtn);
            div.appendChild(btnContainer);
            requestsListEl.appendChild(div);
          });
        } else {
          requestsListEl.innerHTML =
            '<p class="text-gray-500 text-sm">ì•„ì§ ë‹¨ì–´ ì¸ì • ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
      }

      function updateResultScreenUI(gameData) {
        clearSession();
        const rankingsEl = document.getElementById("final-rankings");
        rankingsEl.innerHTML = "";
        const sortedPlayers = Object.values(gameData.players)
          .filter((p) => p.nickname !== "í˜¸ìŠ¤íŠ¸")
          .sort((a, b) => b.bingoCount - a.bingoCount);

        sortedPlayers.forEach((player, index) => {
          const rankDiv = document.createElement("div");
          rankDiv.className =
            "p-3 rounded-lg flex items-center justify-between text-left";
          let rankText;
          if (index === 0) {
            rankText = "ğŸ¥‡ 1ìœ„";
            rankDiv.classList.add("bg-amber-100");
          } else if (index === 1) {
            rankText = "ğŸ¥ˆ 2ìœ„";
            rankDiv.classList.add("bg-gray-200");
          } else if (index === 2) {
            rankText = "ğŸ¥‰ 3ìœ„";
            rankDiv.classList.add("bg-orange-100");
          } else {
            rankText = `${index + 1}ìœ„`;
            rankDiv.classList.add("bg-gray-100");
          }

          rankDiv.innerHTML = `
                    <span class="text-xl font-bold w-16">${rankText}</span>
                    <span class="text-lg font-medium flex-1">${player.nickname}</span>
                    <span class="text-lg font-semibold">${player.bingoCount} ë¹™ê³ </span>
                `;
          rankingsEl.appendChild(rankDiv);
        });

        const topWordsEl = document.getElementById("top-words");
        topWordsEl.innerHTML = "";
        const wordCounts = {};
        Object.values(gameData.players).forEach((player) => {
          if (!player.board) return;
          for (let i = 0; i < player.board.length; i++) {
            if (player.marked[i]) {
              const word = player.board[i];
              if (word) wordCounts[word] = (wordCounts[word] || 0) + 1;
            }
          }
        });

        const sortedWords = Object.entries(wordCounts).sort(
          ([, a], [, b]) => b - a
        );
        sortedWords.slice(0, 5).forEach(([word, count]) => {
          const wordDiv = document.createElement("div");
          wordDiv.className = "p-2 bg-gray-50 rounded-md";
          wordDiv.textContent = `${word} (${count}íšŒ)`;
          topWordsEl.appendChild(wordDiv);
        });
      }

      function createBingoInputGrid(size) {
        const container = document.getElementById("my-bingo-grid-container");
        container.innerHTML = "";
        const grid = document.createElement("div");
        grid.className = "grid gap-1";
        grid.style.gridTemplateColumns = `repeat(${size}, 1fr)`;

        for (let i = 0; i < size * size; i++) {
          const cell = document.createElement("div");
          cell.className =
            "bingo-cell bg-white border border-gray-200 rounded-md";
          const inputDiv = document.createElement("div");
          inputDiv.contentEditable = true;
          inputDiv.dataset.index = i;
          inputDiv.className = "bingo-input-div";
          cell.appendChild(inputDiv);
          grid.appendChild(cell);
        }
        container.appendChild(grid);
      }

      function createBoardElement(
        size,
        flatBoardData,
        flatMarkedData,
        isMyTurn,
        playerId
      ) {
        const container = document.createElement("div");
        container.className = "bingo-grid-container";

        const grid = document.createElement("div");
        grid.className = "grid gap-1";
        grid.style.gridTemplateColumns = `repeat(${size}, 1fr)`;

        for (let i = 0; i < size * size; i++) {
          const cell = document.createElement("div");
          const word = flatBoardData[i] || "";
          const displayText =
            word.length > 15 ? word.substring(0, 15) + "..." : word;
          cell.textContent = displayText;
          cell.title = word;
          cell.className =
            "bingo-cell bg-gray-100 border border-gray-200 rounded-md transition-colors duration-300";
          if (flatMarkedData && flatMarkedData[i]) {
            cell.classList.add("marked");
          }

          if (
            playerId === userId &&
            !isMyTurn &&
            !cell.classList.contains("marked")
          ) {
            cell.classList.add("cursor-pointer", "hover:bg-yellow-200");
            cell.onclick = () => requestWordApproval(word, i);
          }

          if (isMyTurn && !cell.classList.contains("marked")) {
            cell.classList.add("cursor-pointer", "hover:bg-emerald-200");
            cell.onclick = () => callWord(word);
          }
          grid.appendChild(cell);
        }
        container.appendChild(grid);

        // ë¹™ê³  ë¼ì¸ ê·¸ë¦¬ê¸°
        const bingoLines = checkBingo(flatMarkedData, size);
        if (bingoLines.length > 0) {
          const svg = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "svg"
          );
          svg.setAttribute("class", "bingo-line-svg");
          svg.setAttribute("viewBox", "0 0 100 100");

          const cellSize = 100 / size;
          const halfCell = cellSize / 2;

          bingoLines.forEach((line) => {
            const lineEl = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "line"
            );
            lineEl.setAttribute("class", "bingo-line");
            const [type, indexStr] = line.split("-");
            const index = parseInt(indexStr);

            if (type === "row") {
              lineEl.setAttribute("x1", "0");
              lineEl.setAttribute("y1", `${index * cellSize + halfCell}`);
              lineEl.setAttribute("x2", "100");
              lineEl.setAttribute("y2", `${index * cellSize + halfCell}`);
            } else if (type === "col") {
              lineEl.setAttribute("x1", `${index * cellSize + halfCell}`);
              lineEl.setAttribute("y1", "0");
              lineEl.setAttribute("x2", `${index * cellSize + halfCell}`);
              lineEl.setAttribute("y2", "100");
            } else if (type === "diag" && index === 1) {
              // L-R
              lineEl.setAttribute("x1", "0");
              lineEl.setAttribute("y1", "0");
              lineEl.setAttribute("x2", "100");
              lineEl.setAttribute("y2", "100");
            } else if (type === "diag" && index === 2) {
              // R-L
              lineEl.setAttribute("x1", "100");
              lineEl.setAttribute("y1", "0");
              lineEl.setAttribute("x2", "0");
              lineEl.setAttribute("y2", "100");
            }
            svg.appendChild(lineEl);
          });
          container.appendChild(svg);
        }

        return container;
      }

      async function submitBoard() {
        if (!currentGameId || !userId) {
          return;
        }
        const gameCollectionPath = `/artifacts/${appId}/public/data/bingoGames`;
        const gameRef = doc(db, gameCollectionPath, currentGameId);

        try {
          const gameDoc = await getDoc(gameRef);
          if (!gameDoc.exists()) {
            return;
          }
          const gameData = gameDoc.data();
          if (!gameData) {
            return;
          }
          const size = gameData.size;

          const inputs = document.querySelectorAll(
            "#my-bingo-grid-container .bingo-input-div"
          );
          const board2D = [];
          let row = [];
          let allFilled = true;
          for (let i = 0; i < inputs.length; i++) {
            const value = inputs[i].textContent.trim();
            if (!value) allFilled = false;
            row.push(value);
            if ((i + 1) % size === 0) {
              board2D.push(row);
              row = [];
            }
          }

          if (!allFilled) {
            showCustomAlert("ë¹™ê³ íŒì˜ ëª¨ë“  ì¹¸ì„ ì±„ì›Œì£¼ì„¸ìš”.");
            return;
          }

          const flatBoard = board2D.flat();
          const flatMarked = Array(flatBoard.length).fill(false);

          await updateDoc(gameRef, {
            [`players.${userId}.board`]: flatBoard,
            [`players.${userId}.marked`]: flatMarked,
            [`players.${userId}.isReady`]: true,
          });
        } catch (error) {
          console.error("Submit board error:", error);
          showCustomAlert("ë¹™ê³ íŒ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function randomFillBoard() {
        const gameCollectionPath = `/artifacts/${appId}/public/data/bingoGames`;
        const gameRef = doc(db, gameCollectionPath, currentGameId);
        const gameDoc = await getDoc(gameRef);
        if (!gameDoc.exists()) return;
        const gameData = gameDoc.data();

        let availableWords = [];
        if (gameData.randomWords && gameData.randomWords.length > 0) {
          availableWords = [...gameData.randomWords];
        } else {
          const topic = document.getElementById("wait-topic").textContent;
          const sampleWords = {
            ìŒì‹: [
              "ê¹€ì¹˜ì°Œê°œ",
              "ëœì¥ì°Œê°œ",
              "ë¹„ë¹”ë°¥",
              "ë¶ˆê³ ê¸°",
              "ì¡ì±„",
              "ë–¡ë³¶ì´",
              "ìˆœëŒ€",
              "ë¼ë©´",
              "ì¹˜í‚¨",
              "í”¼ì",
              "í–„ë²„ê±°",
              "íŒŒìŠ¤íƒ€",
              "ì´ˆë°¥",
              "ìš°ë™",
              "ëˆê¹ŒìŠ¤",
              "ê°ˆë¹„íƒ•",
              "ì„¤ë íƒ•",
              "ì‚¼ê²¹ì‚´",
              "ê³±ì°½",
              "ë§‰ì°½",
              "ì¡±ë°œ",
              "ë³´ìŒˆ",
              "ëƒ‰ë©´",
              "ì¹¼êµ­ìˆ˜",
              "ìˆ˜ì œë¹„",
            ],
            ë™ë¬¼: [
              "ê°•ì•„ì§€",
              "ê³ ì–‘ì´",
              "í˜¸ë‘ì´",
              "ì‚¬ì",
              "ì½”ë¼ë¦¬",
              "ê¸°ë¦°",
              "í•˜ë§ˆ",
              "ì•…ì–´",
              "ì›ìˆ­ì´",
              "íŒë‹¤",
              "ì½”ì•Œë¼",
              "ìº¥ê±°ë£¨",
              "í­ê·„",
              "ë…ìˆ˜ë¦¬",
              "ì°¸ìƒˆ",
              "ë¹„ë‘˜ê¸°",
              "ê³ ë˜",
              "ìƒì–´",
              "ê±°ë¶ì´",
              "ë±€",
              "ê°œêµ¬ë¦¬",
              "ì‚¬ìŠ´",
              "ì—¬ìš°",
              "ëŠ‘ëŒ€",
              "ê³°",
            ],
            "ì˜í™” ì œëª©": [
              "ê¸°ìƒì¶©",
              "ë¶€ì‚°í–‰",
              "ê·¹í•œì§ì—…",
              "ì‹ ê³¼í•¨ê»˜",
              "ëª…ëŸ‰",
              "êµ­ì œì‹œì¥",
              "ë² í…Œë‘",
              "ë„ë‘‘ë“¤",
              "ì•”ì‚´",
              "ê´‘í•´",
              "íƒì‹œìš´ì „ì‚¬",
              "í•´ìš´ëŒ€",
              "ê´´ë¬¼",
              "ì™•ì˜ë‚¨ì",
              "ì–´ë²¤ì ¸ìŠ¤",
              "ì•„ë°”íƒ€",
              "íƒ€ì´íƒ€ë‹‰",
              "ì¸í„°ìŠ¤í…”ë¼",
              "ê²¨ìš¸ì™•êµ­",
              "ì•Œë¼ë”˜",
              "ë³´í—¤ë¯¸ì•ˆë©ì†Œë””",
              "ì¸ì…‰ì…˜",
              "ë‹¤í¬ë‚˜ì´íŠ¸",
              "ë°˜ì§€ì˜ì œì™•",
              "í•´ë¦¬í¬í„°",
            ],
          };
          availableWords =
            sampleWords[topic] ||
            Array.from({ length: 25 }, (_, i) => `ìƒ˜í”Œ${i + 1}`);
        }

        const inputs = document.querySelectorAll(
          "#my-bingo-grid-container .bingo-input-div"
        );
        const emptyInputs = [];
        const existingWords = new Set();
        inputs.forEach((input) => {
          const value = input.textContent.trim();
          if (value) {
            existingWords.add(value.toLowerCase());
          } else {
            emptyInputs.push(input);
          }
        });

        let wordsToFill = availableWords.filter(
          (word) => !existingWords.has(word.toLowerCase())
        );
        wordsToFill.sort(() => 0.5 - Math.random());

        emptyInputs.forEach((input, index) => {
          if (wordsToFill[index]) {
            input.textContent = wordsToFill[index];
          }
        });
      }

      async function startGame() {
        const gameCollectionPath = `/artifacts/${appId}/public/data/bingoGames`;
        const gameRef = doc(db, gameCollectionPath, currentGameId);
        const gameDoc = await getDoc(gameRef);
        const gameData = gameDoc.data();
        const guestPlayerIds = Object.keys(gameData.players).filter(
          (id) => id !== gameData.hostId
        );

        await updateDoc(gameRef, {
          status: "playing",
          turn: guestPlayerIds[0] || null,
        });
      }

      async function callWord(word) {
        const gameCollectionPath = `/artifacts/${appId}/public/data/bingoGames`;
        const gameRef = doc(db, gameCollectionPath, currentGameId);
        const gameDoc = await getDoc(gameRef);
        const gameData = gameDoc.data();

        if (gameData.turn !== userId || !word) return;

        const updates = {};
        const playerIds = Object.keys(gameData.players);
        let newWinners = [...gameData.winners];

        for (const pid of playerIds) {
          const player = gameData.players[pid];
          if (!player.board || pid === gameData.hostId) continue;

          const newMarked = [...player.marked];
          let changed = false;
          for (let i = 0; i < player.board.length; i++) {
            if (
              player.board[i]?.trim().toLowerCase() ===
              word.trim().toLowerCase()
            ) {
              if (!newMarked[i]) {
                newMarked[i] = true;
                changed = true;
              }
            }
          }
          if (changed) {
            const newBingoCount = checkBingo(newMarked, gameData.size).length;
            updates[`players.${pid}.marked`] = newMarked;
            updates[`players.${pid}.bingoCount`] = newBingoCount;

            if (
              newBingoCount >= gameData.winCondition &&
              !player.isWinner &&
              !newWinners.includes(player.nickname)
            ) {
              updates[`players.${pid}.isWinner`] = true;
              newWinners.push(player.nickname);
            }
          }
        }

        updates.turn = null;
        updates.calledWords = [...gameData.calledWords, word];
        updates.winners = newWinners;

        if (newWinners.length >= gameData.endCondition) {
          updates.status = "finished";
        }

        await updateDoc(gameRef, updates);
      }

      async function setPlayerTurn(playerId) {
        if (!isHost) return;
        const gameCollectionPath = `/artifacts/${appId}/public/data/bingoGames`;
        const gameRef = doc(db, gameCollectionPath, currentGameId);
        await updateDoc(gameRef, { turn: playerId });
      }

      async function skipTurn() {
        if (!isHost) return;
        const gameCollectionPath = `/artifacts/${appId}/public/data/bingoGames`;
        const gameRef = doc(db, gameCollectionPath, currentGameId);
        const gameDoc = await getDoc(gameRef);
        const gameData = gameDoc.data();

        if (!gameData.turn) {
          showCustomAlert(
            "í˜„ì¬ ì§€ì •ëœ í„´ì´ ì—†ìŠµë‹ˆë‹¤. ì°¸ê°€ìë¥¼ í´ë¦­í•´ í„´ì„ ì§€ì •í•´ì£¼ì„¸ìš”."
          );
          return;
        }

        const guestPlayerIds = Object.keys(gameData.players).filter(
          (id) => id !== gameData.hostId
        );
        const currentIndex = guestPlayerIds.indexOf(gameData.turn);
        const nextIndex = (currentIndex + 1) % guestPlayerIds.length;
        const nextPlayerId = guestPlayerIds[nextIndex];

        await updateDoc(gameRef, { turn: nextPlayerId });
      }

      async function requestWordApproval(word, index) {
        if (isHost) return;
        const gameCollectionPath = `/artifacts/${appId}/public/data/bingoGames`;
        const gameRef = doc(db, gameCollectionPath, currentGameId);
        const gameDoc = await getDoc(gameRef);
        const gameData = gameDoc.data();

        const newRequest = {
          requestId: `${userId}-${index}`,
          userId,
          nickname: userNickname,
          word,
          index,
        };

        const existingRequests = gameData.wordRequests || [];
        if (
          existingRequests.some((r) => r.requestId === newRequest.requestId)
        ) {
          showCustomAlert("ì´ë¯¸ í•´ë‹¹ ë‹¨ì–´ì˜ ì¸ì •ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.");
          return;
        }

        await updateDoc(gameRef, {
          wordRequests: [...existingRequests, newRequest],
        });
        showCustomAlert(`'${word}' ë‹¨ì–´ì˜ ì¸ì •ì„ í˜¸ìŠ¤íŠ¸ì—ê²Œ ìš”ì²­í–ˆìŠµë‹ˆë‹¤!`);
      }

      async function approveWordRequest(request) {
        if (!isHost) return;

        const gameCollectionPath = `/artifacts/${appId}/public/data/bingoGames`;
        const gameRef = doc(db, gameCollectionPath, currentGameId);
        const gameDoc = await getDoc(gameRef);
        const gameData = gameDoc.data();

        const playerToUpdate = gameData.players[request.userId];
        const newMarked = [...playerToUpdate.marked];
        newMarked[request.index] = true;

        const newBingoCount = checkBingo(newMarked, gameData.size).length;
        let newWinners = [...gameData.winners];

        const updates = {
          [`players.${request.userId}.marked`]: newMarked,
          [`players.${request.userId}.bingoCount`]: newBingoCount,
          wordRequests: gameData.wordRequests.filter(
            (r) => r.requestId !== request.requestId
          ),
        };

        if (
          newBingoCount >= gameData.winCondition &&
          !playerToUpdate.isWinner &&
          !newWinners.includes(playerToUpdate.nickname)
        ) {
          updates[`players.${request.userId}.isWinner`] = true;
          newWinners.push(playerToUpdate.nickname);
          updates.winners = newWinners;
        }

        if (newWinners.length >= gameData.endCondition) {
          updates.status = "finished";
        }

        await updateDoc(gameRef, updates);
      }

      async function rejectWordRequest(request) {
        if (!isHost) return;
        const gameCollectionPath = `/artifacts/${appId}/public/data/bingoGames`;
        const gameRef = doc(db, gameCollectionPath, currentGameId);
        const gameDoc = await getDoc(gameRef);
        const gameData = gameDoc.data();

        await updateDoc(gameRef, {
          wordRequests: gameData.wordRequests.filter(
            (r) => r.requestId !== request.requestId
          ),
        });
      }

      async function manualEndGame() {
        if (!isHost) return;
        if (
          window.confirm(
            "ì •ë§ë¡œ ê²Œì„ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì°¸ê°€ìì˜ ê²Œì„ì´ ì¢…ë£Œë©ë‹ˆë‹¤."
          )
        ) {
          const gameCollectionPath = `/artifacts/${appId}/public/data/bingoGames`;
          const gameRef = doc(db, gameCollectionPath, currentGameId);
          await updateDoc(gameRef, { status: "finished" });
        }
      }

      // --- ì„¸ì…˜ ê´€ë¦¬ (ì¬ì ‘ì† ê¸°ëŠ¥) ---
      function saveSession() {
        if (currentGameId && userId) {
          const sessionData = {
            gameId: currentGameId,
            userId: userId,
            isHost: isHost,
            nickname: userNickname,
          };
          sessionStorage.setItem(
            "bingoGameSession",
            JSON.stringify(sessionData)
          );
        }
      }

      function clearSession() {
        sessionStorage.removeItem("bingoGameSession");
      }

      async function checkForExistingSession() {
        const savedSessionJSON = sessionStorage.getItem("bingoGameSession");
        if (!savedSessionJSON) return;

        const savedSession = JSON.parse(savedSessionJSON);
        if (
          !savedSession.gameId ||
          !savedSession.userId ||
          userId !== savedSession.userId
        ) {
          clearSession();
          return;
        }

        const gameCollectionPath = `/artifacts/${appId}/public/data/bingoGames`;
        const gameRef = doc(db, gameCollectionPath, savedSession.gameId);
        const gameDoc = await getDoc(gameRef);

        if (gameDoc.exists()) {
          const gameData = gameDoc.data();

          if (
            gameData.status === "finished" ||
            !gameData.players[savedSession.userId]
          ) {
            clearSession();
            return;
          }

          currentGameId = savedSession.gameId;
          userNickname = savedSession.nickname;
          isHost = savedSession.isHost;
          currentRoomCode = gameData.roomCode;

          listenToGameChanges(currentGameId);
        } else {
          clearSession();
        }
      }

      function reshapeArray(flatArray, size) {
        if (!flatArray || !size) return [];
        const reshaped = [];
        for (let i = 0; i < flatArray.length; i += size) {
          reshaped.push(flatArray.slice(i, i + size));
        }
        return reshaped;
      }

      function generateRoomCode() {
        return Math.random().toString(36).substring(2, 7).toUpperCase();
      }

      function copyRoomCode() {
        const code = document.getElementById("room-code-display").textContent;
        const textArea = document.createElement("textarea");
        textArea.value = code;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
          document.execCommand("copy");
          showCustomAlert("ë°© ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
        } catch (err) {
          showCustomAlert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
        document.body.removeChild(textArea);
      }

      function checkBingo(flatMarked, size) {
        if (!flatMarked || !size || flatMarked.length !== size * size)
          return [];
        const marked = reshapeArray(flatMarked, size);
        if (marked.length === 0) return [];

        let bingoLines = [];
        for (let i = 0; i < size; i++) {
          let rowBingo = true;
          let colBingo = true;
          for (let j = 0; j < size; j++) {
            if (!marked[i]?.[j]) rowBingo = false;
            if (!marked[j]?.[i]) colBingo = false;
          }
          if (rowBingo) bingoLines.push(`row-${i}`);
          if (colBingo) bingoLines.push(`col-${i}`);
        }
        let diag1Bingo = true;
        let diag2Bingo = true;
        for (let i = 0; i < size; i++) {
          if (!marked[i]?.[i]) diag1Bingo = false;
          if (!marked[i]?.[size - 1 - i]) diag2Bingo = false;
        }
        if (diag1Bingo) bingoLines.push("diag-1");
        if (diag2Bingo) bingoLines.push("diag-2");

        return bingoLines;
      }

      function showCustomAlert(message) {
        const existingModal = document.querySelector(".modal-backdrop");
        if (existingModal) {
          existingModal.remove();
        }

        const modalBackdrop = document.createElement("div");
        modalBackdrop.className = "modal-backdrop";

        const modalContent = document.createElement("div");
        modalContent.className = "modal-content";

        const messageEl = document.createElement("p");
        messageEl.textContent = message;

        const closeButton = document.createElement("button");
        closeButton.textContent = "í™•ì¸";

        closeButton.onclick = () => {
          modalBackdrop.remove();
        };

        modalContent.appendChild(messageEl);
        modalContent.appendChild(closeButton);
        modalBackdrop.appendChild(modalContent);

        document.body.appendChild(modalBackdrop);
        closeButton.focus();
      }
    </script>
  </body>
</html>
